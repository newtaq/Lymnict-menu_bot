import asyncio
import logging
import sys
from os import getenv

from aiogram import Bot, Dispatcher, Router, filters, types, F
from aiogram.enums.parse_mode import ParseMode
from aiogram.filters import CommandStart
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.types.inline_keyboard_button import InlineKeyboardButton
from aiogram.types.inline_keyboard_markup import InlineKeyboardMarkup
from aiogram.types.keyboard_button import KeyboardButton
from aiogram.types.reply_keyboard_markup import ReplyKeyboardMarkup
from aiogram.types.reply_keyboard_remove import ReplyKeyboardRemove
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.fsm.storage.memory import MemoryStorage

import asyncio 
import datetime

from config import BOT_TOKEN
from jsondb import orgsdb, usersdb, shopdb
from sqlshop import shoptable
import os 
from excel_opener import excel2dict


bot = Bot(BOT_TOKEN)
dp = Dispatcher() 
router = Router()


@dp.message(filters.CommandStart())
async def start(message: types.Message):
    await bot.send_message(message.chat.id, "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –±–æ—Ç-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏—è –≤ –¥–∞–Ω–Ω–æ–º –∑–∞–≤–µ–¥–µ–Ω–∏–∏. –Ø –º–æ–≥—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ —Ä–∞–±–æ—Ç–µ –Ω–∞—à–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ –ø–æ–º–æ—á—å –≤–∞–º –≤—ã–±—Ä–∞—Ç—å –µ–¥—É –¥–ª—è –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏.")
    await asyncio.sleep(1)
    await bot.send_message(message.chat.id, "/help - –ø–æ–ª—É—á–∏—Ç—å —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ")
    await asyncio.sleep(1)
    
    user_id = f"{message.from_user.id}"
    data = usersdb.data 
    
    if not user_id in data:
        data[user_id] = []
        usersdb.data = data 
        
    await menu(message)
    
@dp.message(filters.Command("help"))
async def help(message: types.Message):
    await bot.send_message(message.chat.id, """1. –ï—Å–ª–∏ –≤—ã —è–≤–ª—è–µ—Ç–µ—Å—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º/—É–ø—Ä–∞–≤–ª—è—é—â–∏–º –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è, —Ç–æ –≤—ã–±–µ—Ä–µ—Ç–µ "–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É", –∏ –¥–∞–ª–µ–µ —Å–ª–µ–¥—É–µ—Ç–µ —É–∫–∞–∑–∞–Ω–∏—è–º –±–æ—Ç–∞: –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è, –≤—ã–±–µ—Ä–µ—Ç–µ —Å—Ä–µ–¥–∏ –ø—É–Ω–∫—Ç–æ–≤ –ø—É–Ω–∫—Ç —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –≤–∞—à–µ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è. –ü–æ—Ç–æ–º –≤—ã–±–µ—Ä–µ—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–≤–∞—Ä–∏–∞–Ω—Ç —Å —à–µ—Å—Ç–µ—Ä—ë–Ω–∫–æ–π), –∑–∞—Ç–µ–º –≤—ã–±–µ—Ä–µ—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç —Å–æ —Å—Ç—Ä–µ–ª–æ—á–∫–æ–π. –¢–∞–º –±—É–¥–µ—Ç 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞: —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–≤—ã —Å–º–æ–∂–µ—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤–∞—à–µ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è), –¥–æ–±–∞–≤–∏—Ç—å –º–µ–Ω—é (–¥–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø—Ä–∏—Å–ª–∞—Ç—å —Ñ–∞–π–ª —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º xlsx (*.xlsx)), –≤—ã–π—Ç–∏ –∏–∑ –≥—Ä—É–ø–ø—ã (–µ—Å–ª–∏ –≤—ã –±–æ–ª—å—à–µ –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å —É–ø—Ä–∞–≤–ª—è—é—â–∏–º –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è) –∏ —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É (–µ—Å–ª–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ –ø—Ä–µ–∫—Ä–∞—Ç–∏–ª–æ —Å–≤–æ—ë —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ)
2. –ï—Å–ª–∏ –≤—ã —è–≤–ª—è–µ—Ç–µ—Å—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è, —Ç–æ –≤—ã–±–µ—Ä–µ—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É" –∏ —Å–ª–µ–¥—É–µ—Ç–µ —É–∫–∞–∑–∞–Ω–∏—è–º –±–æ—Ç–∞: –≤—ã–±–µ—Ä–µ—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è, –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ "–º–µ–Ω—é" (—Å–æ –∑–Ω–∞—á–∫–æ–º —Ç–µ–ª–µ–∂–∫–æ–π), –≥–¥–µ –≤—ã —Å–º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å —Å–µ–±–µ –µ–¥—É, –∏ –¥–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω—É, –æ—Ñ–æ—Ä–º–∏–≤ –∑–∞–∫–∞–∑""")

    await asyncio.sleep(2)
    await message.reply("/menu –¥–ª—è –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è –≤ –º–µ–Ω—é")

@dp.message(filters.Command("menu"))
async def menu(message: types.Message):
    kbuilder = InlineKeyboardBuilder()
    kbuilder.button(text="–î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É", callback_data=f"btn_add_org")

    data = usersdb() 
    user_id = f"{message.from_user.id}"

    shopdb_data = shopdb.data
    shopdb_data[user_id] = []
    shopdb.data = shopdb_data

    if user_id in data:
        for org in data[user_id]:
            kbuilder.button(text=f"{org}", callback_data=f"btn_org_{org}__0")
    
        data_len = len(data[user_id])
        kbuilder.adjust(1, *[5 for _ in range(data_len//5)], data_len % 5 + 1)
    kbuilder.row(InlineKeyboardButton(text="–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É", callback_data=f"btn_create_org"))
    await bot.send_message(message.chat.id, f"""\
–í–æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é (/menu):
/start - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –±–æ—Ç–∞
/help - –ø–æ–ª—É—á–∏—Ç—å –ø–æ–º–æ—â—å –ø–æ –±–æ—Ç—É
/addgroup - –¥–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É
/newgroup - —Å–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É""", reply_markup=kbuilder.as_markup())

@dp.callback_query(lambda query: query.data == "menu")
async def menu_query(query: types.CallbackQuery):
    await menu(query.message.reply_to_message)

@dp.callback_query(lambda query: query.data.startswith("btn_org_"))
async def btn_org(query: types.CallbackQuery):
    await bot.answer_callback_query(query.id)
    
    org_name, page = query.data[8:].split("__")
    
    page = int(page)    
    
    kbuilder = InlineKeyboardBuilder()

    categories = list(orgsdb.data[org_name]["menu"].keys())
    
    len_categories = len(categories) / 10
    int_len_categories = int(len_categories)
    if page < 0:
        page += int_len_categories + 1 if len_categories > 1 else 0 
    elif page > int_len_categories:
        page -= int_len_categories + 1 if len_categories > 1 else 0
    
    window = categories[(page)*10:(page+1)*10]
        
    for category in window:
        kbuilder.button(text=category, callback_data=f"btn_orgcategory_{org_name}__{category}__0")
    
    len_window = len(window)
        
    if len_categories > 1:
        kbuilder.button(text="‚óÄÔ∏è", callback_data=f"btn_org_{org_name}__{page-1}")
    kbuilder.add(InlineKeyboardButton(text="üõí", callback_data=f"btn_orgshopper_{org_name}"), 
                InlineKeyboardButton(text="‚öôÔ∏è", callback_data=f"btn_orgsettings_{org_name}"))
    if len_categories > 1:
        kbuilder.button(text="‚ñ∂Ô∏è", callback_data=f"btn_org_{org_name}__{page+1}")
    
    if len_window % 2:
        kbuilder.adjust(*[2 for _ in range(len_window // 2)], 1, 4)
    else: 
        kbuilder.adjust(*[2 for _ in range(len_window // 2)], 4)

    if query.message.text == f"–ú–µ–Ω—é –¥–ª—è {org_name}:":
        await bot.edit_message_reply_markup(query.message.chat.id, query.message.message_id, query.inline_message_id, reply_markup=kbuilder.as_markup())
    else:
        await bot.send_message(query.message.chat.id, f"–ú–µ–Ω—é –¥–ª—è {org_name}:", reply_markup=kbuilder.as_markup())
        

@dp.callback_query(lambda query: query.data.startswith("btn_orgsettings_"))
async def btn_org_settings(query: types.CallbackQuery):
    await bot.answer_callback_query(query.id)
    
    org_name = query.data[16:]
    user_id = f"{query.from_user.id}"
        
    data = orgsdb.data 
    
    kbulder = InlineKeyboardBuilder()
    
    if user_id in data[org_name]["admins"]:
        kbulder.button(text="–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤", callback_data=f"btn_orgmembers_{org_name}__0")
        kbulder.button(text="–î–æ–±–∞–≤–∏—Ç—å –º–µ–Ω—é", callback_data=f"btn_orgadd_menu_{org_name}")
        kbulder.button(text="–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É", callback_data=f"btn_orgdelete_{org_name}")
        kbulder.adjust(1, 1, 1)
    if user_id in data[org_name]["members"]:
        kbulder.button(text="–í—ã–π—Ç–∏ –∏–∑ –≥—Ä—É–ø–ø—ã", callback_data=f"btn_orgleave_{org_name}")        
    
    await bot.send_message(query.message.chat.id, f"–ù–∞—Å—Ç—Ä–æ–π–∫–∏ {org_name}:", reply_markup=kbulder.as_markup())        



@dp.callback_query(lambda query: query.data.startswith("btn_orgleave_"))
async def btn_orgleave(query: types.CallbackQuery):
    await bot.answer_callback_query(query.id)
    org_name = query.data[13:]
    kbuilder = InlineKeyboardBuilder()
    kbuilder.button(text="–î–∞", callback_data=f"btn_orgleave_true_{org_name}")
    await bot.send_message(query.message.chat.id, "–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —ç—Ç—É –≥—Ä—É–ø–ø—É?", reply_markup=kbuilder.as_markup())

   
@dp.callback_query(lambda query: query.data.startswith("btn_orgdelete_"))
async def btn_orgleave(query: types.CallbackQuery):
    await bot.answer_callback_query(query.id)
    org_name = query.data[14:]
    kbuilder = InlineKeyboardBuilder()
    kbuilder.button(text="–î–∞", callback_data=f"btn_orgleave_true_{org_name}")
    await bot.send_message(query.message.chat.id, "–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –≥—Ä—É–ø–ø—É?", reply_markup=kbuilder.as_markup())
    
    
@router.message(filters.Command("cancel"))
async def cancel_handler(message: types.Message, state: FSMContext) -> None:
    current_state = await state.get_state()
    if current_state is None:
        return

    logging.info("Cancelling state %r", current_state)
    await state.clear()
    await message.answer(
        "–û—Ç–º–µ–Ω–µ–Ω–æ",
        reply_markup=ReplyKeyboardRemove(),
    )
    await menu(message)
    
# region btn_orgadd_menu_form
class ExcelForm(StatesGroup):
    excel_file = State()
    
@router.callback_query(lambda query: query.data.startswith("btn_orgadd_menu_"))
async def btn_orgadd_menu(query: types.CallbackQuery, state: FSMContext):
    await bot.answer_callback_query(query.id)
    org_name = query.data[16:]
    await state.update_data(org_name=org_name)
    await state.set_state(ExcelForm.excel_file)
    await bot.send_message(query.message.chat.id, f"–ü—Ä–∏—à–ª–∏—Ç–µ *.xlsx —Ñ–∞–π–ª –¥–ª—è {org_name}:\n–ö–æ–º–∞–Ω–¥–∞ /cancel –¥–ª—è –æ—Ç–º–µ–Ω—ã")
    
@router.message(ExcelForm.excel_file)    
async def btn_orgadd_menu_message(message: types.Message, state: FSMContext):
    org_name = (await state.get_data())["org_name"]
    await state.clear() 
    excel_file: types.Document = message.document
    logging.warning(org_name)
    user_id = f"{message.from_user}"
    orgsdb_data = orgsdb.data 
    
    
    file_path = r"files/" + excel_file.file_name
    await bot.download(excel_file, file_path)
    menu_json = excel2dict(file_path)
    os.remove(file_path)
    
    orgsdb_data[org_name]["menu"] = menu_json
    orgsdb.data = orgsdb_data
    
                    
    await menu(message)
# endregion
            
@dp.callback_query(lambda query: query.data.startswith("btn_orgmembers_"))
async def btn_orgmembers(query: types.CallbackQuery):
    await bot.answer_callback_query(query.id)
    
    org_name, page = query.data[15:].split("__")
    
    page = int(page)    
    
    kbuilder = InlineKeyboardBuilder()

    items = orgsdb.data[org_name]["members"]
    
    len_items = len(items) / 10
    int_len_items = int(len_items)
    if page < 0:
        page += int_len_items + 1 if len_items > 0 else 0
    elif page > int_len_items:
        page -= int_len_items + 1 if len_items > 0 else 0

    window = items[(page)*10:(page+1)*10]
        
    for id, item in enumerate(window):
        kbuilder.button(text=item, callback_data=f"btn_orgmember_{org_name}__{id}")
    
    len_window = len(window)
    kbuilder.adjust(*[2 for _ in range(len_window // 2)], len_window % 2 + 1)
    
    if len_items > 1:       
        kbuilder.row(InlineKeyboardButton(text="‚óÄÔ∏è", callback_data=f"btn_orgmembers_{org_name}__{page-1}"))
    kbuilder.button(text="‚Ü©Ô∏è", callback_data=f"btn_orgsettings_{org_name}")
    if len_items > 1:
        kbuilder.button(text="‚ñ∂Ô∏è", callback_data=f"btn_orgmembers_{org_name}__{page+1}")            

        
    if query.message.text == f"–ù–∞—Å—Ç—Ä–æ–π–∫–∏ {org_name}:":
        await bot.edit_message_reply_markup(query.message.chat.id, query.message.message_id, query.inline_message_id, reply_markup=kbuilder.as_markup())
    else:
        await bot.send_message(query.message.chat.id, f"–ù–∞—Å—Ç—Ä–æ–π–∫–∏ {org_name}:", reply_markup=kbuilder.as_markup())        
        
@dp.callback_query(lambda query: query.data.startswith("btn_orgcategory_"))
async def btn_org(query: types.CallbackQuery):
    await bot.answer_callback_query(query.id)
    
    org_name, category, page = query.data[16:].split("__")
    
    page = int(page)    
    
    kbuilder = InlineKeyboardBuilder()

    items = orgsdb.data[org_name]["menu"][category]
    
    len_items = len(items) / 10
    int_len_items = int(len_items)
    if page < 0:
        page += int_len_items + 1 if len_items > 0 else 0
    elif page > int_len_items:
        page -= int_len_items + 1 if len_items > 0 else 0

    window = items[(page)*10:(page+1)*10]
        
    for id, item in enumerate(window):
        kbuilder.button(text=item, callback_data=f"btn_orgitem_{org_name}__{category}__{id+page}")
    
    len_window = len(window)
    
    if len_items > 1:       
        kbuilder.button(text="‚óÄÔ∏è", callback_data=f"btn_orgcategory_{org_name}__{category}__{page-1}")
    kbuilder.add(InlineKeyboardButton(text="üõí", callback_data=f"btn_orgshopper_{org_name}"), 
                InlineKeyboardButton(text="‚Ü©Ô∏è", callback_data=f"btn_org_{org_name}__0"))
    if len_items > 1:
        kbuilder.button(text="‚ñ∂Ô∏è", callback_data=f"btn_orgcategory_{org_name}__{category}__{page+1}")            

    if len_window % 2:
        kbuilder.adjust(*[2 for _ in range(len_window // 2)], 1, 4)
    else: 
        kbuilder.adjust(*[2 for _ in range(len_window // 2)], 4)
        
    if query.message.text == f"{category}:" or query.message.text == f"–ú–µ–Ω—é –¥–ª—è {org_name}:":
        await bot.edit_message_reply_markup(query.message.chat.id, query.message.message_id, query.inline_message_id, reply_markup=kbuilder.as_markup())
    else:
        await bot.send_message(query.message.chat.id, f"{category}:", reply_markup=kbuilder.as_markup())


@dp.callback_query(lambda query: query.data.startswith("btn_orgitem_"))
async def btn_orgitem(query: types.CallbackQuery):
    await bot.answer_callback_query(query.id)
    org_name, category, id = query.data[12:].split("__")
    
    shopdb_data = shopdb.data
    shopdb_data[f"{query.message.chat.id}"] += [orgsdb.data[org_name]["menu"][category][int(id)]]
    shopdb.data = shopdb_data
    
    
@dp.callback_query(lambda query: query.data.startswith("btn_orgshopper_"))
async def btn_orgitem(query: types.CallbackQuery):

    await bot.answer_callback_query(query.id)
    
    kbuilder = InlineKeyboardBuilder()
    kbuilder.button(text="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑ –≤ —Å—Ç–æ–ª–æ–≤—É—é", callback_data="btn_endrequest")
    
    items_list = shopdb.data[f'{query.message.chat.id}']
    
    if not items_list:
        await bot.send_message(query.message.chat.id, "–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞")
        return 
    
    table = shoptable.get_data(query.message.chat.id, f"{datetime.date.today()}")
    if table:
        shoptable.delete_data(query.message.chat.id, f"{datetime.date.today()}")
    shoptable.insert_data(query.message.chat.id, f"{datetime.date.today()}", items_list)

    await bot.send_message(query.message.chat.id, f"–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞: {', '.join(items_list)}", reply_markup=kbuilder.as_markup())
    
@dp.callback_query(lambda query: query.data == "btn_endrequest")
async def btn_orgitem(query: types.CallbackQuery):

    await bot.answer_callback_query(query.id)    

    await bot.send_message(query.message.chat.id, text="–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —Å—Ç–æ–ª–æ–≤—É—é. –ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞.")

    await bot.send_message(query.message.chat.id, "/menu –¥–ª—è –≤—ã–∑–æ–≤–∞ –º–µ–Ω—é")
    
    
# region btn_create_org_form
class CreateForm(StatesGroup):
    org_name = State()

@router.callback_query(lambda query: query.data == "btn_create_org")
async def btn_create_org(query: types.CallbackQuery, state: FSMContext):
    await bot.answer_callback_query(query.id)
    await state.set_state(CreateForm.org_name)
    await bot.send_message(query.message.chat.id, "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏:\n–ö–æ–º–∞–Ω–¥–∞ /cancel –¥–ª—è –æ—Ç–º–µ–Ω—ã")

    
@router.message(CreateForm.org_name)    
async def btn_create_org_message(message: types.Message, state: FSMContext):
    org_name = message.text
    await state.clear() 
    user_id = f"{message.from_user.id}"
    
    
    usersdbdata = usersdb.data

    if org_name in orgsdb.data:
        await message.reply("–ü–æ—Ö–æ–∂–µ –≥—Ä—É–ø–ø–∞ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
    else:
        usersdbdata[user_id] += [org_name] 
        usersdb.data = usersdbdata
        orgsdb.data |= {org_name: {"admins": [user_id], "members": [user_id], "menu": {}}}
        await message.reply("–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!")
        
    await menu(message)
# endregion 

# region btn_add_org_form
class AddFrom(StatesGroup):
    org_name = State()

@router.callback_query(lambda query: query.data == "btn_add_org")
async def btn_add_org(query: types.CallbackQuery, state: FSMContext):
    await bot.answer_callback_query(query.id)
    await state.set_state(AddFrom.org_name)
    await bot.send_message(query.message.chat.id, "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏:\n–ö–æ–º–º–∞–Ω–¥–∞ /cancel –¥–ª—è –æ—Ç–º–µ–Ω—ã")
    
@router.message(AddFrom.org_name)    
async def btn_add_org_message(message: types.Message, state: FSMContext):
    org_name = message.text
    await state.clear() 
    user_id = f"{message.from_user.id}"
    db = orgsdb.data
    
    kbuilder = InlineKeyboardBuilder()
    
    if org_name in db:
        
        if user_id in db[org_name]["members"]:
            await message.reply("–í—ã –∏ —Ç–∞–∫ –≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ")
            await menu(message)
            return
        
        await message.reply("–ó–∞—è–≤–∫–∞ –≤ –≥—Ä—É–ø–ø—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!")
        
        kbuilder.button(text="–ü—Ä–∏–Ω—è—Ç—å", callback_data=f"btn_add_org_application_true_{org_name}__{message.from_user.id}")
        kbuilder.button(text="–û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"btn_add_org_application_false_{org_name}__{message.from_user.id}")
        
        
        tasks = []
        for admin in db[org_name]["admins"]:
            tasks.append(bot.send_message(int(admin), f"–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –≤ {org_name} –æ—Ç [{message.from_user.full_name}](t.me//{message.from_user.username})", 
                                          parse_mode=ParseMode.MARKDOWN_V2, disable_web_page_preview=True, reply_markup=kbuilder.as_markup()))
        asyncio.gather(*tasks)
        
    else: 
        kbuilder.button(text="–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â–µ —Ä–∞–∑", callback_data="btn_add_org")
        kbuilder.row(InlineKeyboardButton(text="–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É", callback_data="btn_create_org"), InlineKeyboardButton(text="–ú–µ–Ω—é", callback_data="menu"))
        await message.reply("–ü–æ—Ö–æ–∂–µ —Ç–∞–∫–æ–π –≥—Ä—É–ø–ø—ã –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
    
    await menu(message)    
    
@dp.callback_query(lambda query: query.data.startswith("btn_add_org_application_true_"))
async def btn_create_org_application_true(query: types.CallbackQuery):
    await bot.answer_callback_query(query.id)
    await bot.edit_message_reply_markup(query.message.chat.id, query.message.message_id, query.inline_message_id)
    org_name, user_id = query.data[29:].split("__")
    await bot.send_message(int(user_id), f"–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –≤ {org_name} –±—ã–ª–∞ –æ–¥–æ–±—Ä–µ–Ω–∞")
    
    orgsdb_data = orgsdb.data 
    orgsdb_data[org_name]["members"] += [user_id]
    orgsdb.data = orgsdb_data
    
    usersdb_data = usersdb.data 
    usersdb_data[user_id] += [org_name]
    usersdb.data = usersdb_data
    
    await bot.send_message(user_id, "/menu –¥–ª—è –≤—ã–∑–æ–≤–∞ –º–µ–Ω—é")
    await bot.send_message(query.message.chat.id, "/menu –¥–ª—è –≤—ã–∑–æ–≤–∞ –º–µ–Ω—é")
    
    
@dp.callback_query(lambda query: query.data.startswith("btn_add_org_application_false_"))
async def btn_create_org_application_true(query: types.CallbackQuery):
    await bot.answer_callback_query(query.id)
    await bot.edit_message_reply_markup(query.message.chat.id, query.message.message_id, query.inline_message_id)
    org_name, user_id = query.data[30:].split("__")
    await bot.send_message(int(user_id), f"–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –≤ {org_name} –±—ã–ª–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞")
    
    await bot.send_message(user_id, "/menu –¥–ª—è –≤—ã–∑–æ–≤–∞ –º–µ–Ω—é")
    await bot.send_message(query.message.chat.id, "/menu –¥–ª—è –≤—ã–∑–æ–≤–∞ –º–µ–Ω—é")
# endregion 


async def main() -> None:
    dp.include_router(router)
    await dp.start_polling(bot)


if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO, stream=sys.stdout)
    asyncio.run(main())